<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Outside My Way</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      display: flex;
      align-items: center;
      padding: 10px;
      background-color: #f5f5f5;
    }
    header img {
      height: 50px;
      margin-right: 15px;
    }
    header h1 {
      font-size: 1.5rem;
      margin: 0;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 10px;
      background-color: #f0f0f0;
    }
    label {
      font-weight: bold;
    }
    #map {
      width: 100%;
      height: 80vh;
    }
    .legend {
      background: white;
      padding: 10px;
      position: absolute;
      bottom: 10px;
      left: 10px;
      font-size: 0.9rem;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    .legend div {
      margin-bottom: 5px;
    }
    .legend span {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 5px;
    }
  </style>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+Bx0s0/jzQM4JZkLB+QvP2Qb6Fzv9z5s2sCNhHSAw="
    crossorigin=""
  />
</head>
<body>
  <header>
    <img src="logo.png" alt="Outside My Way Logo" />
    <h1>Outside My Way</h1>
  </header>
  <div class="controls">
    <label for="categoryFilter">Filter by Activity Type:</label>
    <select id="categoryFilter" multiple>
      <option value="camping">Camping</option>
      <option value="hiking">Hiking</option>
      <option value="trailhead">Trailhead</option>
      <option value="free">Free Camping</option>
      <option value="swimming">Swimming</option>
    </select>

    <label for="searchInput">Search by Name or Location:</label>
    <input type="text" id="searchInput" placeholder="Outside My Way" />
  </div>
  <div id="map"></div>
  <div class="legend">
    <div><span style="background: gold;"></span> Free Camping</div>
    <div><span style="background: green;"></span> Camping</div>
    <div><span style="background: blue;"></span> Hiking/Trailhead</div>
    <div><span style="background: gray;"></span> Other</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j8MkfB0v1w+Lr7qjJ8cCkNd6FjzT9Hyg6QZ/lN8="
    crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    const map = L.map('map').setView([39.5, -98.35], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const markers = [];

    function getColorForActivity(tags) {
      const tagStr = tags.join(',').toLowerCase();
      if (tagStr.includes("free")) return "gold";
      if (tagStr.includes("camping")) return "green";
      if (tagStr.includes("hiking") || tagStr.includes("trailhead")) return "blue";
      return "gray";
    }

    function addMarker(lat, lon, name, desc, address, city, state, zip, directions, tags) {
      const color = getColorForActivity(tags);
      const marker = L.circleMarker([lat, lon], {
        radius: 8,
        fillColor: color,
        color: '#000',
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
      }).addTo(map);

      marker.bindPopup(
        `<strong>${name}</strong><br>${desc}<br>${address} ${city}, ${state} ${zip}<br><a href="${directions}" target="_blank">Get Directions</a>`
      );
      marker.bindTooltip(name);
      marker.tags = tags;
      marker.name = name.toLowerCase();
      markers.push(marker);
    }

    async function loadRIDBData() {
      const res = await fetch('/.netlify/functions/fetchRIDB');
      const json = await res.json();
      const facilities = json.RECDATA || [];

      facilities.slice(0, 100).forEach(facility => {
        const lat = parseFloat(facility.FacilityLatitude);
        const lon = parseFloat(facility.FacilityLongitude);
        if (!lat || !lon) return;

        const name = facility.FacilityName;
        const desc = facility.FacilityDescription || "No description available.";
        const address = facility.FacilityStreetAddress?.[0]?.AddressLine1 || "";
        const city = facility.FacilityStreetAddress?.[0]?.City || "";
        const state = facility.FacilityStreetAddress?.[0]?.State || "";
        const zip = facility.FacilityStreetAddress?.[0]?.PostalCode || "";
        const directions = `https://www.google.com/maps?q=${lat},${lon}`;

        const tags = (facility.FacilityKeywords || "").toLowerCase().split(',');
        addMarker(lat, lon, name, desc, address, city, state, zip, directions, tags);
      });
    }

    async function loadCSVData() {
      const res = await fetch('locations.csv');
      const text = await res.text();
      const results = Papa.parse(text, { header: true });

      results.data.forEach(loc => {
        const lat = parseFloat(loc.latitude);
        const lon = parseFloat(loc.longitude);
        if (!lat || !lon) return;

        const name = loc.name;
        const desc = loc.description || "No description available.";
        const address = loc.address || "";
        const city = loc.city || "";
        const state = loc.state || "";
        const zip = loc.zip || "";
        const directions = `https://www.google.com/maps?q=${lat},${lon}`;

        const tags = (loc.category || "").toLowerCase().split(',');
        addMarker(lat, lon, name, desc, address, city, state, zip, directions, tags);
      });
    }

    function applyFilters() {
      const selected = Array.from(document.getElementById("categoryFilter").selectedOptions).map(o => o.value.toLowerCase());
      const query = document.getElementById("searchInput").value.toLowerCase();

      markers.forEach(marker => {
        const matchCategory = selected.length === 0 || selected.some(tag => marker.tags.includes(tag));
        const matchSearch = marker.name.includes(query);
        if (matchCategory && matchSearch) {
          map.addLayer(marker);
        } else {
          map.removeLayer(marker);
        }
      });
    }

    document.getElementById("categoryFilter").addEventListener("change", applyFilters);
    document.getElementById("searchInput").addEventListener("input", applyFilters);

    loadRIDBData();
    loadCSVData();
  </script>

  <!-- OUTLINE NOTES FOR PROJECT REFERENCE

  ✅ TECH STACK + HOSTING
  - HTML, JS, and CSV-based dataset
  - Using Netlify for deployment (Chromebook compatible)
  - Firebase selected for contact form + possible saved lists later
  - No backend server; client-side only

  ✅ DATA STRUCTURE
  - Master CSV file cleaned and merged
  - Categories normalized for filtering (e.g., hiking, swimming, free camping)
  - Using PapaParse for CSV-to-JSON conversion in-browser

  ✅ UI DECISIONS
  - Logo placed in top-left of header
  - Filters stacked vertically (Chromebook viewport constraint)
  - Category filter allows multi-select
  - Search box placeholder = "Outside My Way"

  ✅ CHROMEBOOK LIMITATIONS
  - Cannot run local servers or heavy IDEs
  - All edits must be done in GitHub web editor or ChatGPT canvas
  - Images and CSV hosted via GitHub repo

  ✅ TASKS IN PROGRESS
  - [x] Set up Netlify serverless function to fetch RIDB API data
  - [x] Securely store RIDB API key in Netlify environment variables
  - [x] Implement interactive map using Leaflet.js
  - [x] Connect front-end JS to call fetchRIDB API
  - [x] Display results as map pins using FacilityLatitude + FacilityLongitude
  - [x] Display filtered pins by category and keyword (RIDB only)
  - [x] Add pin color legend and custom colors based on activity type
  - [x] Add richer metadata to popups (address, directions link)
  - [x] Load and parse CSV data with PapaParse (if needed)
  - [ ] Finalize favicon + responsive tweaks

  ✅ NEXT STEPS
  - Allow CSV and RIDB pins to co-exist and share filter system ✅
  - Improve mobile responsiveness of map and controls
  - Add footer with GitHub + Contact link
  - Add dedicated filter/view for Appalachian Trail dataset (future)

  -->
</body>
</html>

